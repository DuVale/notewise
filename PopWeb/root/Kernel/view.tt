<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head>
        <title>[% kernel.name %] - PopWeb</title>
    </head>
    <link rel="stylesheet" type="text/css" href="/style.css"/>
    <body>
        <div id="outerframe">
            <div>
                <div id="search">
                    Search: <input autocomplete="off" id="mysearchfield" name="s">
                    <div class="auto_complete" id="searchresults"></div>
                </div>
            </div>
            <div id="parents" class="section">
                <div class="header">
                <span onclick="if(this.innerHTML == 'V'){this.innerHTML='&gt;'; document.getElementById('parents').className='section';} else {this.innerHTML='V'; document.getElementById('parents').className='section expanded';}">&gt;</span>
                    Parents
                </div>
            </div>
            <div id="relationships" class="section">
                <div class="header">
                <span onclick="if(this.innerHTML == 'V'){this.innerHTML='&gt;'; document.getElementById('relationships').className='section';} else {this.innerHTML='V'; document.getElementById('relationships').className='section expanded';}">&gt;</span>
                Relationships
                </div>
            </div>
            <div id="viewkernel" class="vkernel">
                <input type="text" id="namefield0" class="namefield" value="[% kernel.name %]"
                style="width: [% kernel.name.length * 0.55 + 1 %]em;"/>
                <div class="body" id="background">
                    [% FOR vkernel = visible_kernels %]
                        [%INCLUDE 'Kernel/kernel.tt' i=0 %]
                    [%END%]
                </div>
            </div>
        </div>
        <script type="text/javascript" src="/js/wz_jsgraphics.js"></script>
        <script type="text/javascript" src="/js/prototype.js"></script>
        <script type="text/javascript" src="/js/dragndrop.js"></script>
        <script type="text/javascript" src="/js/jsdbi.js"></script>
        <script type="text/javascript" src="/js/utils.js"></script>
        <script type="text/javascript" src="/js/linedraw.js"></script>
        <script type="text/javascript" src="/js/new_relationship.js"></script>
        <script type="text/javascript" src="/js/relationship.js"></script>
        <script type="text/javascript" src="/js/kernelobject.js"></script>
        <script type="text/javascript" src="/js/viewkernel.js"></script>
        <script type="text/javascript" src="/js/kernel.js"></script>
        <script type="text/javascript" src="/js/visiblekernel.js"></script>
        <script type="text/javascript" src="/js/controls.js"></script>
        <script type="text/javascript" src="/js/effects.js"></script>
        [%#
        use this instead of the above garbage to get faster loading of javascript
        <script type="text/javascript" src="/javascript"></script>
        %]
        <script>
            // XXX this is pretty nasty - put this inside the view's vkernel instead
            var vkernelCache = {};
        </script>

        [% FOR vkernel = visible_kernels %]
            [% i = 0 %]
            [%INCLUDE 'Kernel/kernel-js.tt'%]
        [%END%]
        <script>

            var viewKernelId=[%kernel.id%];
            // XXX precache this instead of fetching it
            var view = new ViewKernel([%kernel.id%],document.getElementById('viewkernel'));

            function addKernel(e){
                alert("body addKernel called");

                var posx = 0;
                var posy = 0;
                if (!e) var e = window.event;
                if (e.pageX || e.pageY)
                {
                        posx = e.pageX;
                        posy = e.pageY;
                }
                else if (e.clientX || e.clientY)
                {
                        posx = e.clientX + document.body.scrollLeft;
                        posy = e.clientY + document.body.scrollTop;
                }

                var x = posx-background.offsetLeft;
                var y = posy-background.offsetTop;
                var vkernel = VisibleKernel.insert({container_object: viewKernelId,
                                                    x: x,
                                                    y: y,
                                                    width: 100,
                                                    height: 100,
                                                    collapsed: 1});
                vkernel.realize(background);
                vkernel.select();
                vkernel.namefield.focus();
            }

            function clearSelection (e) {
                VisibleKernel.prototype.clearSelectionAndTerminate(e);
            }
            document.getElementById('background').addEventListener("dblclick", addKernel, false);
            document.addEventListener("mousedown", clearSelection, false);

            document.getElementById('mysearchfield').focus();

//            var vkernel1=vkernelCache['130/433'];
//            var vkernel2=vkernelCache['130/432'];
//            if(vkernel1 && vkernel2){
//                var relationship = new Relationship(vkernel1,vkernel2);
//            } else {
//    //            alert("couldn't find the right kernels to create the relationship");
//            }

            new Ajax.Autocompleter('mysearchfield', 'searchresults', '/ac', {frequency: .2});
        </script>
    </body>
</html>
