<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head>
        <script type="text/javascript" src="/js/prototype.js"></script>
        <script type="text/javascript" src="/js/rico.js"></script>
        <script type="text/javascript" src="/js/jsdbi.js"></script>
        <script type="text/javascript" src="/js/linedraw.js"></script>
        <script type="text/javascript" src="/js/new_relationship.js"></script>
        <script type="text/javascript" src="/js/kernel.js"></script>
        <script type="text/javascript" src="/js/visiblekernel.js"></script>
        <script type="text/javascript" src="/js/controls.js"></script>
        <script type="text/javascript" src="/js/effects.js"></script>
        <script type="text/javascript" src="/js/dragdrop.js"></script>
        <style>
            #search {
                float: right;
                margin: 5px;
            }

            #search input {
                border: 1px solid black;
            }

            #outerframe {
                border: 0px solid black;
                width:800px;
            }
            .section {
                border-left: 1px solid black;
                border-right: 1px solid black;
                clear: both;
            }
            .section.expanded {
                height: 100px;
            }
            .section .header {
                background: #21bbf4;
                border-top: 1px solid black;
                border-bottom: 1px solid black;
            }
            .section span {
                cursor: default;
            }

            #kernel0 {
                border: 0px;
                position: static;
                width: 800px;
                height: 600px;
            }
            #background {
                border: 1px solid black;
                width: 794px;
                height: 564px;
                top: 0px;
            }
            #namefield0 {
                width: 200px;
            }
            .vkernel {
                border: 1px solid #00F;
                width: 100px;
                height: 100px;
                position: absolute;
                background: blue;
                z-index: 1;
            }

            .vkernel.selected {
                border: 3px solid #21bbff;
            }

            .expandbutton,
            .removebutton,
            .relationshipbutton {
                background: blue;
                color: white;
                display: none;
                position: absolute;
                width: 20px;
                height: 20px;
                padding: 0px;
            }

            .expandbutton {
                left: -30px;
                top: 0px;
            }

            .removebutton{
                right: -30px;
                top: 0px;
            }

            .relationshipbutton {
                margin-left: 48%;
                top: -30px;
            }

            .vkernel.selected > .expandbutton,
            .vkernel.selected > .removebutton,
            .vkernel.selected > .relationshipbutton {
                display: block;
            }

            .vkernel .namefield {
                border: 0px solid white;
                background: blue;
                color: white;
                display: block;
                position: relative;
                margin-left: auto;
                margin-right: auto;
                top: 0px;
                width: 78px;
                height: 28px;
                text-align: center;
                font-size: 20px;
            }
            .vkernel .body {
                background: white;
                width: auto;
                height: 65px;
                position: relative;
                margin: 2px;
                top: 0px;
                clear: both;
            }
            .leftgrippie, .rightgrippie {
                background: url('/images/gripper.png');
                z-index:0;
                width: 10px;
                height: 30px;
                position: absolute;
                cursor: move;
            }
            .leftgrippie {
                top: 0;
                left: 0;
                width: 100%;
            }
            .rightgrippie {
                top: 0;
                right: 0;
                width: 0;
                height: 0;
            }

            .corner {
                position: absolute;
                background: url('/images/corner.gif');
                width: 15px;
                height: 15px;
                cursor: se-resize;
                z-index:0;
            }
            div.auto_complete {
              width: 350px;
              background: #0ff;
              z-index:100;
            }
            div.auto_complete ul {
              border:1px solid #888;
              margin:0;
              padding:0;
              width:100%;
              list-style-type:none;
            }
            div.auto_complete ul li {
              margin:0;
              padding:3px;
            }
            div.auto_complete ul li.selected { 
              background-color: #ffb; 
            }
            div.auto_complete ul strong.highlight { 
              color: #800; 
              margin:0;
              padding:0;
            }
        </style>
        <script>
            // Prevent a drag on the text field from moving the object
            var i=0;
            var onMouseDownTextFieldListener = function(e) {
                dndMgr._terminateEvent(e);
            };

            var updateName = function (e) {
               var targ;
               if (e.target) targ = e.target;
               else if (e.srcElement) targ = e.srcElement;
               if (targ.nodeType == 3) // defeat Safari bug
                    targ = targ.parentNode;
               window.status = "got blur: "+(i++)+" value: "+targ.value;
               ajaxEngine.sendRequest( 'updateKernel',
                                       'id=2',
                                       'name='+targ.value );
            };
        </script>
    </head>
    <body>
        <div id="outerframe">

            <div>
                <div id="search">
                    Search: <input autocomplete="off" id="mysearchfield" name="s">
                    <div class="auto_complete" id="searchresults"></div>
                </div>
                <script>
                new Ajax.Autocompleter('mysearchfield', 'searchresults', '/ac', {frequency: .2});
                </script>
            </div>
            <div id="parents" class="section">
                <div class="header">
                <span onclick="if(this.innerHTML == 'V'){this.innerHTML='&gt;'; document.getElementById('parents').className='section';} else {this.innerHTML='V'; document.getElementById('parents').className='section expanded';}">&gt;</span>
                    Parents
                </div>
            </div>
            <div id="relationships" class="section">
                <div class="header">
                <span onclick="if(this.innerHTML == 'V'){this.innerHTML='&gt;'; document.getElementById('relationships').className='section';} else {this.innerHTML='V'; document.getElementById('relationships').className='section expanded';}">&gt;</span>
                Relationships
                </div>
            </div>
            <div id="kernel0" class="vkernel">
                <input type="text" id="namefield0" class="namefield" value="[% kernel.name %]"/>
                <div class="body" id="background">

                    [% FOR vkernel = visible_kernels %]
                        [%INCLUDE 'Kernel/kernel.tt'%]
                    [%END%]
                </div>
            </div>
        </div>

        <script>
        var viewKernelId=[%kernel.id%];
        dndMgr.registerDropZone( new CustomDropzone('background') );

        var background = document.getElementById('background');

        var i = 42;
        function addKernel(e){

            var posx = 0;
            var posy = 0;
            if (!e) var e = window.event;
            if (e.pageX || e.pageY)
            {
                    posx = e.pageX;
                    posy = e.pageY;
            }
            else if (e.clientX || e.clientY)
            {
                    posx = e.clientX + document.body.scrollLeft;
                    posy = e.clientY + document.body.scrollTop;
            }

            var x = posx-background.offsetLeft;
            var y = posy-background.offsetTop;
            var vkernel = VisibleKernel.insert({container_object: viewKernelId,
                                                x: x,
                                                y: y,
                                                width: 100,
                                                height: 100,
                                                collapsed: 1});
            vkernel.realize(background);
            vkernel.select();
            vkernel.namefield.focus();
        }

        function clearSelection (e) {
            VisibleKernel.prototype.clearSelectionAndTerminate(e);
        }
        document.getElementById('background').addEventListener("dblclick", addKernel, false);
        document.addEventListener("mousedown", clearSelection, false);

        document.getElementById('mysearchfield').focus();
        </script>
    </body>
</html>
