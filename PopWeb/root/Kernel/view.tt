<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head>
        <title>[% kernel.name %] - PopWeb</title>
        <style>
            body {
                padding: 0px;
                margin: 0px;
            }

            #search {
                float: right;
                margin: 5px;
            }

            #search input {
                border: 1px solid black;
                padding: 2px;
            }

            #outerframe {
                border: 0px solid red;
                position: absolute;
                left: 5px;
                right: 5px;
                top: 5px;
                bottom: 20px;
            }

            .section {
                border-left: 1px solid black;
                border-right: 1px solid black;
                clear: both;
            }
            .section.expanded {
                height: 100px;
            }
            .section .header {
                background: #21bbf4;
                border-top: 1px solid black;
                border-bottom: 1px solid black;
            }
            .section span {
                cursor: default;
            }

            #viewkernel {
                border: 0px;
                margin: 0px;
                position: relative;
                width: 100%;
                height: 85%;
            }
            #background {
                border: 1px solid black;
                top: 30px;
                bottom: 5px;
                left: 5px;
                right: 5px;
                position: absolute;
            }
            #namefield0 {
                width: 200px;
            }

            .vkernel {
                border: 1px solid #00F;
                position: absolute;
                background: blue;
                z-index: 1;
                min-width: 99px;
                min-height: 30px;
            }

            .vkernel.selected {
                border: 3px solid #21bbff;
            }

            .expandbutton,
            .removebutton,
            .relationshipbutton {
                background: blue;
                color: white;
                display: none;
                position: absolute;
                width: 20px;
                height: 20px;
                padding: 0px;
            }

            .expandbutton {
                left: -30px;
                top: 0px;
            }

            .removebutton{
                right: -30px;
                top: 0px;
            }

            .relationshipbutton {
                margin-left: 48%;
                top: -30px;
            }

            .vkernel.selected > .expandbutton,
            .vkernel.selected > .removebutton,
            .vkernel.selected > .relationshipbutton {
                display: block;
            }

            .hidebutton {
                display: none;
            }

            .relationship.selected .removebutton,
            .relationship.selected .hidebutton {
                display: block;
            }

            .vkernel .namefield {
                border: 0px solid white;
                background: blue;
                color: white;
                display: block;
                position: relative;
                margin-left: auto;
                margin-right: auto;
                top: 0px;
                width: 78px;
                height: 28px;
                text-align: center;
                font-size: 20px;
            }
            .vkernel .body {
                background: white;
                position: absolute;
                left: 2px;
                right: 2px;
                top: 30px;
                bottom: 2px;
                clear: both;
                overflow: hidden;
            }

            .vkernel .body.activated {
                background: #d2eeff;
            }

            .vkernel.collapsed {
                min-height: 30px;
                max-height: 30px;
            }

            .vkernel.collapsed .body {
                height: 0px;
                display: none;
            }

            .leftgrippie, .rightgrippie {
                background: url('/images/gripper.png');
                z-index:0;
                width: 10px;
                height: 30px;
                position: absolute;
                cursor: move;
            }
            .leftgrippie {
                top: 0px;
                left: 0px;
                width: 100%;
            }
            .rightgrippie {
                top: 0px;
                right: 0px;
                width: 0px;
                height: 0px;
            }

            .corner {
                position: absolute;
                background: url('/images/corner.gif');
                width: 15px;
                height: 15px;
                cursor: se-resize;
                z-index:0;
            }
            div.auto_complete {
              width: 350px;
              background: #0ff;
              z-index:100;
            }
            div.auto_complete ul {
              border:1px solid #888;
              margin:0;
              padding:0;
              width:100%;
              list-style-type:none;
            }
            div.auto_complete ul li {
              margin:0;
              padding:3px;
            }
            div.auto_complete ul li.selected { 
              background-color: #ffb; 
            }
            div.auto_complete ul strong.highlight { 
              color: #800; 
              margin:0;
              padding:0;
            }
            div.dummyDiv {
                position: absolute;
                background: #888888;
            }
        </style>
    </head>
    <body>
        <div id="outerframe">
            <div>
                <div id="search">
                    Search: <input autocomplete="off" id="mysearchfield" name="s">
                    <div class="auto_complete" id="searchresults"></div>
                </div>
            </div>
            <div id="parents" class="section">
                <div class="header">
                <span onclick="if(this.innerHTML == 'V'){this.innerHTML='&gt;'; document.getElementById('parents').className='section';} else {this.innerHTML='V'; document.getElementById('parents').className='section expanded';}">&gt;</span>
                    Parents
                </div>
            </div>
            <div id="relationships" class="section">
                <div class="header">
                <span onclick="if(this.innerHTML == 'V'){this.innerHTML='&gt;'; document.getElementById('relationships').className='section';} else {this.innerHTML='V'; document.getElementById('relationships').className='section expanded';}">&gt;</span>
                Relationships
                </div>
            </div>
            <div id="viewkernel" class="vkernel">
                <input type="text" id="namefield0" class="namefield" value="[% kernel.name %]"/>
                <div class="body" id="background">
                    [% FOR vkernel = visible_kernels %]
                        [%INCLUDE 'Kernel/kernel.tt' i=0 %]
                    [%END%]
                </div>
            </div>
        </div>
        <script type="text/javascript" src="/js/wz_jsgraphics.js"></script>
        <script type="text/javascript" src="/js/prototype.js"></script>
        <script type="text/javascript" src="/js/dragndrop.js"></script>
        <script type="text/javascript" src="/js/jsdbi.js"></script>
        <script type="text/javascript" src="/js/utils.js"></script>
        <script type="text/javascript" src="/js/linedraw.js"></script>
        <script type="text/javascript" src="/js/new_relationship.js"></script>
        <script type="text/javascript" src="/js/relationship.js"></script>
        <script type="text/javascript" src="/js/kernelobject.js"></script>
        <script type="text/javascript" src="/js/viewkernel.js"></script>
        <script type="text/javascript" src="/js/kernel.js"></script>
        <script type="text/javascript" src="/js/visiblekernel.js"></script>
        <script type="text/javascript" src="/js/controls.js"></script>
        <script type="text/javascript" src="/js/effects.js"></script>
        [%#
        use this instead of the above garbage to get faster loading of javascript
        <script type="text/javascript" src="/javascript"></script>
        %]
        <script>
            // XXX this is pretty nasty - put this inside the view's vkernel instead
            var vkernelCache = {};
        </script>

        [% FOR vkernel = visible_kernels %]
            [% i = 0 %]
            [%INCLUDE 'Kernel/kernel-js.tt'%]
        [%END%]
        <script>

            var viewKernelId=[%kernel.id%];
            // XXX precache this instead of fetching it
            var view = new ViewKernel([%kernel.id%],document.getElementById('viewkernel'));

            function addKernel(e){
                alert("body addKernel called");

                var posx = 0;
                var posy = 0;
                if (!e) var e = window.event;
                if (e.pageX || e.pageY)
                {
                        posx = e.pageX;
                        posy = e.pageY;
                }
                else if (e.clientX || e.clientY)
                {
                        posx = e.clientX + document.body.scrollLeft;
                        posy = e.clientY + document.body.scrollTop;
                }

                var x = posx-background.offsetLeft;
                var y = posy-background.offsetTop;
                var vkernel = VisibleKernel.insert({container_object: viewKernelId,
                                                    x: x,
                                                    y: y,
                                                    width: 100,
                                                    height: 100,
                                                    collapsed: 1});
                vkernel.realize(background);
                vkernel.select();
                vkernel.namefield.focus();
            }

            function clearSelection (e) {
                VisibleKernel.prototype.clearSelectionAndTerminate(e);
            }
            document.getElementById('background').addEventListener("dblclick", addKernel, false);
            document.addEventListener("mousedown", clearSelection, false);

            document.getElementById('mysearchfield').focus();

//            var vkernel1=vkernelCache['130/433'];
//            var vkernel2=vkernelCache['130/432'];
//            if(vkernel1 && vkernel2){
//                var relationship = new Relationship(vkernel1,vkernel2);
//            } else {
//    //            alert("couldn't find the right kernels to create the relationship");
//            }

            new Ajax.Autocompleter('mysearchfield', 'searchresults', '/ac', {frequency: .2});
        </script>
    </body>
</html>
